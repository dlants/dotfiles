#!/bin/bash
# Attach to an existing tmux session, or start a new one

# Check if argument is a remote session (host:path format where host is not a local path)
is_remote_session() {
  local arg="$1"
  # Match "dev" exactly, or "host:/path" where host is not a local directory
  if [[ "$arg" == "dev" ]]; then
    return 0
  fi
  if [[ "$arg" =~ ^([^/:]+):(.*)$ ]]; then
    local host="${BASH_REMATCH[1]}"
    # If host portion exists as a local directory, it's not remote
    if [ -d "$host" ]; then
      return 1
    fi
    return 0
  fi
  return 1
}

# Handle remote session (e.g., "dev" or "dev:/infra")
create_remote_session() {
  local arg="$1"
  local host remote_path session_name

  if [[ "$arg" =~ ^([^/:]+):(.+)$ ]]; then
    host="${BASH_REMATCH[1]}"
    remote_path="${BASH_REMATCH[2]}"
  else
    host="$arg"
    remote_path="/src"
  fi

  session_name="${host}${remote_path}"

  # Create the session if it doesn't exist
  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -ds "$session_name"

    # Store remote info in session environment
    tmux set-environment -t "$session_name" TA_REMOTE_HOST "$host"
    tmux set-environment -t "$session_name" TA_REMOTE_PATH "$remote_path"

    # Set up hook for new windows in this session to auto-SSH
    tmux set-hook -t "$session_name" after-new-window \
      "run-shell 'tmux send-keys \"ssh -o RemoteCommand=none -t $host \\\"cd $remote_path && exec \\\\\\\$SHELL\\\"\" Enter'"

    # SSH into the first window
    tmux send-keys -t "$session_name" "ssh -o RemoteCommand=none -t $host \"cd $remote_path && exec \\\$SHELL\"" Enter
  fi

  # Attach or switch to the session
  if [ -n "$TMUX" ]; then
    exec tmux switch-client -t "$session_name"
  else
    exec tmux attach -t "$session_name"
  fi
}

# With a path argument: create/attach to a session for that directory
if [ -n "$1" ]; then
  # Check if this is a remote session
  if is_remote_session "$1"; then
    create_remote_session "$1"
  fi

  dir="$1"
  session_name=$(basename -- "$dir" | tr '.' '_')

  if [ -n "$TMUX" ]; then
    # Inside tmux: create session in background and switch to it
    if ! tmux has-session -t "=$session_name" 2>/dev/null; then
      tmux new-session -ds "$session_name" -c "$dir"
    fi
    exec tmux switch-client -t "$session_name"
  else
    # Outside tmux: create and attach
    exec tmux new-session -As "$session_name" -c "$dir"
  fi
fi

# No arguments: attach to existing session or start a new one
if [ -n "$TMUX" ]; then
  echo "Already in tmux. Use 'ta <path>' to create/switch to a session."
  exit 1
fi

session_name=$(basename -- "$PWD" | tr '.' '_')
tmux attach 2>/dev/null || exec tmux new-session -s "$session_name"
